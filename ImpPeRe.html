<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Imperial Penal Report</title>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="ImpPeRe.js"></script>
	<link rel="stylesheet" href="ImpPeRe.css">
</head>

<body>

	<h2>Imperial Penal Report</h2>

	<table border="2" width="100%">
		<tr>
			<td style="vertical-align:top;">
				<div class="form-group">
					<label for="locationDropdown">Location:
						<select id="locationDropdown">
							<option value="">-- Current Location --</option>
						</select>
					</label>
				</div>
				<div id="locationDetails" class="section widthHalf">
					<h3>General Information</h3>
					<p>
						<strong>Region:</strong> <span id="currentRegion">unknown</span>
						<strong>Sector:</strong> <span id="currentSector">unknown</span>
						<strong>System:</strong> <span id="currentSystem">unknown</span>
						<strong>Capital City:</strong> <span id="currentCapital">unknown</span>
						<strong>Starport:</strong> <span id="currentStarport">unknown</span>
						<strong>Map:</strong> <span id="currentMap">unknown</span>
					</p>
					<h3>Atmosphere & Terrain</h3>
					<p>
						<strong>Atmosphere:</strong> <span id="currentAtmosphere">unknown</span>
						<strong>Terrain:</strong> <span id="currentTerrain">unknown</span>
						<strong>Inhabitants:</strong> <span id="currentInhabitants">unknown</span>
						<strong>Climate:</strong> <span id="currentClimate">unknown</span>
						<strong>Gravity:</strong> <span id="currentGravity">unknown</span>
						<strong>URL Link:</strong> <a id="currentURL"
							href="https://starwars.fandom.com/wiki/Unknown_Regions/Legends"
							target="_blank">unknown</a>
					</p>
					<h3>Current Conditions</h3>
					<p>
						<strong>Climate:</strong> unknown
						<strong>Weather:</strong> unknown
						<strong>Terrain:</strong> unknown
					</p>
				</div>
			</td>
			<td style="vertical-align:top;">
				<div class="form-group">
					<label for="destinationDropdown">Destination:
						<select id="destinationDropdown">
							<option value="">-- Select Destination --</option>
						</select>
					</label>
					<div id="destinationDetails" class="section widthHalf">
					<h3>General Information</h3>
					<p>
						<strong>Region:</strong> <span id="destRegion">unknown</span>
						<strong>Sector:</strong> <span id="destSector">unknown</span>
						<strong>System:</strong> <span id="destSystem">unknown</span>
						<strong>Capital City:</strong> <span id="destCapital">unknown</span>
						<strong>Starport:</strong> <span id="destStarport">unknown</span>
						<strong>Map:</strong> <span id="destMap">unknown</span>
					</p>
					<h3>Atmosphere & Terrain</h3>
					<p>
						<strong>Atmosphere:</strong> <span id="destAtmosphere">unknown</span>
						<strong>Terrain:</strong> <span id="destTerrain">unknown</span>
						<strong>Inhabitants:</strong> <span id="destInhabitants">unknown</span>
						<strong>Climate:</strong> <span id="destClimate">unknown</span>
						<strong>Gravity:</strong> <span id="destGravity">unknown</span>
						<strong>URL Link:</strong> <a id="destURL"
							href="https://starwars.fandom.com/wiki/Unknown_Regions/Legends"
							target="_blank">unknown</a>
					</p>
				</div>
			</td>
		</tr>
	</table>

	<table border="2" width="100%">
		<tr><!-- Imperial Presence -->
			<td style="vertical-align:middle;">
				<div style="vertical-align:top; display:block; margin:10px; padding:10px; border:5px solid grey; background-color:darkGrey;">
					<h4 style="text-align:center; margin-top:0px; margin-bottom:5px">Starports</h4>
					<strong>Landing Fee:</strong> <span id="textFeePortLanding"></span><br/>
					<strong>Berthing Fee (per day):</strong> <span id="textFeePortBerthing"></span><br/>
					<strong>Customs Fee:</strong> <span id="textFeeCustoms"></span><br/>
					<strong>Visitation Fee:</strong> <span id="textFeeVisitation"></span><br/>
					<strong>Smuggling Penalty:</strong> <span id="textFeeSmuggling"></span><br/>
					<strong>Departure Wait:</strong> <span id="textWaitDeparture"></span><br/>
					<strong>Fuel Cells (each):</strong> <span id="textFeeFuelCell"></span><br/>
					<strong>Power (per day):</strong> <span id="textFeePortPower"></span><br/>
					<strong>Consumables (per day):</strong> <span id="textFeeConsumables"></span><br/>
					<strong>Maintenance (per day):</strong> <span id="textFeePortMaintenance"></span><br/>
				</div>
				<div style="vertical-align:top; display:block; margin:10px; padding:10px; border:5px solid grey; background-color:darkGrey;">
					<h4 style="text-align:center; margin-top:0px; margin-bottom:5px">Weapon Permits</h4>
					<strong>Concealed Weapons:</strong> <span id="textPermitWeaponConcealed"></span><br/>
					<strong>Small Arms:</strong> <span id="textPermitWeaponSmall"></span><br/>
					<strong>Rifles, Large Melee:</strong> <span id="textPermitWeaponRifle"></span><br/>
					<strong>Heavy Weapons:</strong> <span id="textPermitWeaponHeavy"></span><br/>
					<strong>Light Armor:</strong> <span id="textPermitArmorLight"></span><br/>
					<strong>Restricted/Military:</strong> <span id="textPermitArmorPower"></span><br/>
				</div>
				<div style="vertical-align:top; display:block; margin:10px; padding:10px; border:5px solid grey; background-color:darkGrey;">
					<h4 style="text-align:center; margin-top:0px; margin-bottom:5px">Contraband</h4>
					<strong>Spice:</strong> <span id="textLawSpice"></span><br/>
					<strong>Trespassing:</strong> <span id="textLawTrespassing"></span><br/>
					<strong>Military Gear:</strong> <span id="textLawMilitary"></span><br/>
					<strong>Slicing:</strong> <span id="textLawSlicing"></span><br/>
					<strong>Criticism of the Empire:</strong> <span id="textLawCriticism"></span><br/>
					<strong>Minor Theft:</strong> <span id="textLawTheft"></span><br/>
					<strong>Bribery:</strong> <span id="textLawBribery"></span><br/>
				</div>
			</td>
			<td style="vertical-align: top; display: block;">
				<h4 style="text-align:center; margin-top:0px; margin-bottom:5px">Local Conditions</h4>
				<ul id="localEvents">
					<li id="arrivalEvent">ATTENTION, NAVIGATOR: You have arrived safely.</li>
					<li id="localWeather">Local Weather and Terrain: unknown</li>
				</ul>
				<p align="center">[Each PC, and the GM, may select up to 1 event to make it <em>real</em> or <em>rumor</em>; <em>*</em> indicates for one transaction only, but a Destiny Point may be used to create a permanent NPC.]</p>
			</td>
		</tr>
	</table>

	<script>

		// Converts a number to an integer, max 5, min 0.
		function sanitize0to5(val)
		{
			const saneVal = (Number.isInteger(Math.round(val)) ? Math.round(val) : 0);
			const retVal = Math.min(Math.max(saneVal, 0), 5); // integer, 0 to 5 inclusive
			return retVal;
		}

		// Converts a number to an integer, max 5, min -5.
		function sanitizeMinus5to5(val)
		{
			const saneVal = (Number.isInteger(Math.round(val)) ? Math.round(val) : 0);
			const retVal = Math.min(Math.max(saneVal, -5), 5); // integer, -5 to 5 inclusive
			return retVal;
		}

		// Converts a number to an integer, max 9, min 0.
		// (Rarity goes higher as value goes lower)
		function sanitizeRarity(val)
		{
			const saneVal = (Number.isInteger(Math.round(-val)) ? Math.round(val) : 0);
			const retVal = Math.min(Math.max(saneVal, 0), 9); // integer, 0 to 9 inclusive
			return retVal;
		}

		// Converts a number to display value: "XXcr" or "(waived)"
		function creditsOrWaived(val)
		{
			const saneVal = (Number.isInteger(Math.round(val)) ? Math.round(val) : 0);
			if (saneVal === 0)
			{
				return "(waived)";
			}
			else
			{
				return saneVal + "cr";
			}
			return retVal;
		}

		function rarityModFor(json)
		{
			baseRarity = json.Rarity;
			region = json.Region;
			regionRarity = regions.find(item => item.Name === json.Region).Rarity;
			return baseRarity + regionRarity;
		}

		// Converts a number to display value: "Rarity X(R)" or ""
		function rarityText(val)
		{
			retVal = "";
			saneRarity = sanitizeRarity(val);
			if (saneRarity>0)
			{
				retVal += "Rarity " + saneRarity;
			  if (saneRarity>6)
			  {
				  retVal += "(R) ";
			  }
			  retVal += ", ";
			}
			return retVal;
		}

		// Converts a number to display value for weapon/armor permits
		function permitText(val, cost)
		{
			const rarity = 1 - sanitizeMinus5to5(val);
			switch(sanitizeMinus5to5(val))
			{
				case -5: return "Felony (Permit " + rarityText(rarity + 2) + cost + "cr)"; break;
				case -4: return "Felony (Permit " + rarityText(rarity) + cost + "cr)"; break;
				case -3: return "Misdemeanor (Permit " + rarityText(rarity) + cost + "cr)"; break;
				case -2: return "Infraction (Permit " + rarityText(rarity) + cost + "cr)"; break;
				case -1: return "frowned on (Permit " + rarityText(rarity) + cost + "cr)"; break;
				case 0: return "tolerated"; break;
				case 1: return "no restrictions"; break;
				case 2: return "common"; break;
				case 3: return "recommended"; break;
				case 4: return "recommended"; break;
				case 5: return "recommended"; break;
				default: return "ERROR: return invalid val in permitText()";
			}

			return "ERROR in permitText()";
		}

		// Converts a number to display value for various local crimes
		function legalityOf(val)
		{
			const saneVal = sanitizeMinus5to5(val);
			switch(sanitizeMinus5to5(saneVal))
			{
				case -5: return "Felony";
				case -4: return "Felony";
				case -3: return "Misdemeanor";
				case -2: return "Infraction";
				case -1: return "frowned upon";
				case 0: return "tolerated";
				case 1: return "allowed";
				case 2: return "encouraged";
				case 3: return "encouraged";
				case 4: return "encouraged";
				case 5: return "encouraged";
			}
		}

		// converts a number to a starport description
		// "Operational Costs" fan supplement grades them 1 (best) to 5 (worst)
		function starportText(val) {
			switch(sanitize0to5(val))
			{
				case 0: return "(no starport listed)";
				case 1: return "Imperial Class";
				case 2: return "Stellar Class";
				case 3: return "Standard Class";
				case 4: return "Limited Services";
				case 5: return "Landing Field";
			}
			return "ERROR: unknown"; // fallthrough default
		}

		// Arrival event
		function populateArrivalEvent(hiddenRounds) {
			arrivalEvent = "ATTENTION, NAVIGATOR: ";
			if (hiddenRounds > 0)
			{
				arrivalEvent += "You are hidden for " + hiddenRounds + " round(s) from detection attempts.";
			}
			else
			{
				arrivalEvent += "You have arrived safely.";
			}
			$("#arrivalEvent").text(arrivalEvent);

			const localWeather = "sunny and mild (how boring)"; // @FIX
			const localTerrain = "some starport"; // @FIX
			$("#localWeather").text("Local Weather and Terrain: " + localWeather + ", " + localTerrain);
		}

		// Imperial Presence events
		function populateImperialEvents(eventCount)
		{
			for (ii = 0; ii < eventCount; ii++)
			{
				$("#localEvents").append(arrivalEvents[ii]);
			}
		}

		// Local events
		function populateEmpireEvents(eventCount)
		{
			for (ii = 0; ii < eventCount; ii++)
			{
				const newEvent = localEmpireEvents[Math.floor(Math.random() * localEmpireEvents.length)];
				$("#localEvents").append(newEvent);
			}
		}

		function populateOldWestEvents(eventCount)
		{
			for (ii = 0; ii < eventCount; ii++)
			{
				const newEvent = localOldWestEvents[Math.floor(Math.random() * localOldWestEvents.length)];
				$("#localEvents").append(newEvent);
			}
		}

		$(document).ready(function () {
			// minimize collapsible sections
			$("#locationDetails").slideUp();
			$("#destinationDetails").slideUp();


			// Populate location dropdown
			const $locationDropdown = $("#locationDropdown");
			$.each(locations, function (index, location) {
				$locationDropdown.append(
					$("<option>", { value: location.Name, text: location.Name })
				);
			});

			// Populate destination dropdown
			const $destinationDropdown = $("#destinationDropdown");
			$.each(locations, function (index, location) {
				$destinationDropdown.append(
					$("<option>", { value: location.Name, text: location.Name })
				);
			});

			// Toggle button functionality
			$(".toggleBtn").click(function () {
				const target = $(this).data("target");
				$(target).slideToggle();
			});

			// Location dropdown events
			$("#locationDropdown").on("change", function () {
				$("#locationDetails").slideDown(); // display current location details
				const currentLocation = $("#locationDropdown").val();
				const currentLoc = locations.find(item => item.Name === currentLocation); // JSON object
				const currentRegion = regions.find(region => region.Name === currentLoc.Region); // JSON object
				const rarityMod = rarityModFor(currentLoc);
				const hiddenRounds = Math.round(Math.random() * 2); // @FIX

				// Reset local events
				$("#localEvents").empty();
				$("#localEvents").append('<li id="arrivalEvent">ATTENTION, NAVIGATOR: You have arrived safely.</li>');
				$("#localEvents").append('<li id="localWeather">Local Weather and Terrain: unknown</li>');

				// Arrival event
				populateArrivalEvent(hiddenRounds);

				// Imperial Presence events
				populateImperialEvents(currentLoc.ImperialPresence);

				// Local events
				populateEmpireEvents(currentLoc.ImperialPresence);
				populateEmpireEvents(currentRegion.ImperialPresence);

				// Old West events
				populateOldWestEvents(currentLoc.OldWestiness);
				populateOldWestEvents(currentRegion.OldWestiness);

				// Flora & Fauna events
				populateOldWestEvents(currentLoc.Megafauna);

				// Options calculations & variables
				const shipSilhouette = 4;
				const shipCargoDeclared = 0;

				// Current Location update screen elements
				$('#currentRegion').text(currentLoc.Region);
				$('#currentSector').text(currentLoc.Sector);
				$('#currentSystem').text(currentLoc.System);
				$('#currentCapital').text(currentLoc.CapitalCity);
				$('#currentMap').text(currentLoc.Map);
				$('#currentAtmosphere').text(currentLoc.Atmosphere);
				$('#currentTerrain').text(currentLoc.Terrain);
				$('#currentInhabitants').text(currentLoc.Inhabitants);
				$('#currentClimate').text(currentLoc.Climate);
				$('#currentGravity').text(currentLoc.Gravity);
				$('#currentStarport').text(starportText(currentLoc.starport));
				$('#currentURL').attr('title', currentLoc.Name);
				$('#currentURL').attr('href', currentLoc.URL);
				$('#currentURL').text(currentLoc.Name);

				// Empire Presence calculations
				// https://star-wars-rpg-ffg.fandom.com/wiki/Category:Ship_Operating
				const feePortLanding = (sanitize0to5(currentLoc.ImperialPresence) + sanitize0to5(currentRegion.ImperialPresence)) * 10;
				const textFeePortLanding = creditsOrWaived(feePortLanding);
				const feePortBerthing = Math.round(feePortLanding * 0.1);
				const textFeePortBerthing = creditsOrWaived(feePortBerthing);
				const feeFuelCell = feePortBerthing; // @FIX see the URL above
				const textFeeFuelCell = creditsOrWaived(Math.max(feeFuelCell, 10));
				const feePortPower = feePortBerthing; // @FIX see the URL above
				const textFeePortPower = creditsOrWaived(Math.max(feePortPower, 10));
				const feeConsumables = feePortBerthing; // @FIX see the URL above
				const textFeeConsumables = creditsOrWaived(Math.max(feeConsumables, 10));
				const feePortMaintenance = feePortBerthing; // @FIX see the URL above
				const textFeePortMaintenance = creditsOrWaived(Math.max(feePortMaintenance, 10));
				const feeCustoms = Math.round(shipCargoDeclared * 0.01); // "waived" if zero
				const textFeeCustoms = creditsOrWaived(Math.max(feeCustoms, 10));
				const feeVisitation = Math.round(feePortBerthing * 0.1); // "waived" if zero
				const textFeeVisitation = creditsOrWaived(Math.max(feeVisitation, 10));
				const feeSmuggling = Math.round(shipCargoDeclared * 0.2); // "no cargo declared" if no cargo; "(minor bribe)" if small
				const textFeeSmuggling = creditsOrWaived(Math.max(feeSmuggling, 10));
				const waitDeparture = Math.round(feePortLanding); // in hours
				const textWaitDeparture = (waitDeparture>24
					? (waitDeparture/24).toFixed(1) + " days"
					: waitDeparture.toFixed(0) + " hours"
					);

				// Empire Presence update screen elements
				$('#textFeePortLanding').text(textFeePortLanding);
				$('#textFeePortBerthing').text(textFeePortBerthing);
				$('#textFeeCustoms').text(textFeeCustoms);
				$('#textFeeVisitation').text(textFeeVisitation);
				$('#textFeeSmuggling').text(textFeeSmuggling);
				$('#textWaitDeparture').text(textWaitDeparture);
				$('#textFeeFuelCell').text(textFeeFuelCell);
				$('#textFeePortPower').text(textFeePortPower);
				$('#textFeeConsumables').text(textFeeConsumables);
				$('#textFeePortMaintenance').text(textFeePortMaintenance);

				// Weapon Permits calculations
				const baseWeapon = currentRegion.OldWestiness;

				const permitWeaponConcealed = baseWeapon;
				const permitWeaponConcealedCost = (0 - permitWeaponConcealed) * 10;
				const textPermitWeaponConcealed = permitText(permitWeaponConcealed, permitWeaponConcealedCost, rarityMod);

				const permitWeaponSmall = baseWeapon - 1;
				const permitWeaponSmallCost = (0 - permitWeaponSmall) * 10;
				const textPermitWeaponSmall = permitText(permitWeaponSmall, permitWeaponSmallCost, rarityMod);

				const permitWeaponRifle = baseWeapon -	2;
				const permitWeaponRifleCost = (0 - permitWeaponRifle) * 10;
				const textPermitWeaponRifle = permitText(permitWeaponRifle, permitWeaponRifleCost, rarityMod);

				const permitWeaponHeavy = baseWeapon - 3;
				const permitWeaponHeavyCost = (0 - permitWeaponHeavy) * 10;
				const textPermitWeaponHeavy = permitText(permitWeaponHeavy, permitWeaponHeavyCost, rarityMod);

				const permitArmorLight = baseWeapon -2;
				const permitArmorLightCost = (0 - permitArmorLight) * 10;
				const textPermitArmorLight = permitText(permitArmorLight, permitArmorLightCost, rarityMod);

				const permitArmorPower = baseWeapon - 3;
				const permitArmorPowerCost = (0 - permitArmorPower) * 10;
				const textPermitArmorPower = permitText(permitArmorPower, permitArmorPowerCost, rarityMod);

				// Weapon Permits update screen elements
				$('#textPermitWeaponConcealed').text(textPermitWeaponConcealed);
				$('#textPermitWeaponSmall').text(textPermitWeaponSmall);
				$('#textPermitWeaponRifle').text(textPermitWeaponRifle);
				$('#textPermitWeaponHeavy').text(textPermitWeaponHeavy);
				$('#textPermitArmorLight').text(textPermitArmorLight);
				$('#textPermitArmorPower').text(textPermitArmorPower);

				// Law & Order calculations
				const baseLaw = 0; // - sanitizeMinus5to5(currentLoc.ImperialPresence + currentRegion.ImperialPresence);

				const lawSpice = baseLaw + currentLoc.Spice + currentRegion.Spice;
				const textLawSpice = legalityOf(lawSpice);

				const lawTrespassing = baseLaw + currentLoc.Trespassing + currentRegion.Trespassing;
				const textLawTrespassing = legalityOf(lawTrespassing);

				const lawMilitary = baseLaw + currentLoc.Military + currentRegion.Military;
				const textLawMilitary = legalityOf(lawMilitary);

				const lawSlicing = baseLaw + currentLoc.Slicing + currentRegion.Slicing;
				const textLawSlicing = legalityOf(lawSlicing);

				const lawCriticism = baseLaw + currentLoc.Criticism + currentRegion.Criticism;
				const textLawCriticism = legalityOf(lawCriticism);

				const lawTheft = baseLaw + currentLoc.Theft + currentRegion.Theft;
				const textLawTheft = legalityOf(lawTheft);

				const lawBribery = baseLaw + currentLoc.Bribery + currentRegion.Bribery;
				const textLawBribery = legalityOf(lawBribery);

				// Law & Order update screen elements
				$('#textLawSpice').text(textLawSpice);
				$('#textLawTrespassing').text(textLawTrespassing);
				$('#textLawMilitary').text(textLawMilitary);
				$('#textLawSlicing').text(textLawSlicing);
				$('#textLawCriticism').text(textLawCriticism);
				$('#textLawTheft').text(textLawTheft);
				$('#textLawBribery').text(textLawBribery);
			});

			// Destination dropdown events
			$("#destinationDropdown").on("change", function () {
				$("#destinationDetails").slideDown();
				const currentDestination = $("#destinationDropdown").val();
				const destLoc = locations.find(item => item.Name === currentDestination); // JSON object

				$('#destRegion').text(destLoc.Region);
				$('#destSector').text(destLoc.Sector);
				$('#destSystem').text(destLoc.System);
				$('#destCapital').text(destLoc.CapitalCity);
				$('#destMap').text(destLoc.Map);
				$('#destAtmosphere').text(destLoc.Atmosphere);
				$('#destTerrain').text(destLoc.Terrain);
				$('#destInhabitants').text(destLoc.Inhabitants);
				$('#destClimate').text(destLoc.Climate);
				$('#destGravity').text(destLoc.Gravity);
				$('#destURL').attr('title', destLoc.Name);
				$('#destURL').attr('href', destLoc.URL);
			});

		});
	</script>

</body>

</html>
